{% extends "base.html" %}

{% block title %}Métodos de Pago{% endblock %}

{% block extra_css %}
<style>
.draggable {
    cursor: move;
}
.dragging {
    opacity: 0.5;
    background-color: #e0e7ff;
}
.drag-over {
    border-top: 3px solid #667eea;
}
</style>
{% endblock %}

{% block content %}
<div class="bg-white rounded-lg shadow-lg p-6">
    <!-- Header -->
    <div class="flex justify-between items-center mb-6">
        <div>
            <h2 class="text-2xl font-bold text-gray-800">Métodos de Pago</h2>
            <p class="text-gray-600 mt-1">Administrar métodos de pago y sus fórmulas</p>
        </div>
        <button onclick="showAddModal()" class="bg-gradient-to-r from-indigo-500 to-purple-500 text-white px-4 py-2 rounded-lg hover:from-indigo-600 hover:to-purple-600 transition">
            <i class="fas fa-plus"></i> Agregar Método
        </button>
    </div>

    <div class="mb-4 p-3 bg-blue-50 border-l-4 border-blue-400 rounded">
        <p class="text-sm text-blue-800">
            <i class="fas fa-hand-paper"></i> 
            <strong>Arrastra y suelta</strong> las filas para cambiar el orden de visualización
        </p>
    </div>

    <!-- Tabla de Métodos de Pago -->
    <div class="overflow-x-auto">
        <table class="min-w-full bg-white border border-gray-200 rounded-lg">
            <thead class="bg-gradient-to-r from-indigo-500 to-purple-500 text-white">
                <tr>
                    <th class="px-6 py-3 text-left w-16">
                        <i class="fas fa-grip-vertical"></i>
                    </th>
                    <th class="px-6 py-3 text-left">Orden</th>
                    <th class="px-6 py-3 text-left">Código</th>
                    <th class="px-6 py-3 text-left">Nombre</th>
                    <th class="px-6 py-3 text-left">Fórmula USD</th>
                    <th class="px-6 py-3 text-center">Acciones</th>
                </tr>
            </thead>
            <tbody id="sortable-tbody">
                {% for pm in payment_methods %}
                <tr class="border-b hover:bg-gray-50 transition draggable" 
                    data-id="{{ pm.id }}" 
                    draggable="true">
                    <td class="px-6 py-4 text-gray-400">
                        <i class="fas fa-grip-vertical"></i>
                    </td>
                    <td class="px-6 py-4">
                        <span class="bg-gray-100 px-3 py-1 rounded-full text-sm font-bold">
                            #{{ pm.display_order }}
                        </span>
                    </td>
                    <td class="px-6 py-4">
                        <span class="font-bold text-indigo-600">{{ pm.code }}</span>
                    </td>
                    <td class="px-6 py-4">{{ pm.name }}</td>
                    <td class="px-6 py-4">
                        {% set first_quote = pm.quotes[0] if pm.quotes else None %}
                        {% if first_quote %}
                            {% if first_quote.value_type == 'manual' %}
                            <span class="bg-green-100 text-green-800 text-xs px-2 py-1 rounded">
                                Manual: {{ "%.4f"|format(first_quote.usd_value) }} USD
                            </span>
                            {% else %}
                            <span class="bg-blue-100 text-blue-800 text-xs px-2 py-1 rounded font-mono">
                                {{ first_quote.usd_formula }}
                            </span>
                            {% endif %}
                        {% else %}
                        <span class="text-gray-400 text-xs">Sin cotizaciones</span>
                        {% endif %}
                    </td>
                    <td class="px-6 py-4">
                        <div class="flex justify-center space-x-2">
                            <!-- Botón Fórmula -->
                            <button type="button"
                                    data-pm-id="{{ pm.id }}" 
                                    data-pm-code="{{ pm.code }}" 
                                    data-pm-name="{{ pm.name }}"
                                    {% set first_quote = pm.quotes[0] if pm.quotes else None %}
                                    {% if first_quote %}
                                    data-value-type="{{ first_quote.value_type }}"
                                    data-usd-value="{{ first_quote.usd_value if first_quote.usd_value else '' }}"
                                    data-usd-formula="{{ first_quote.usd_formula if first_quote.usd_formula else '' }}"
                                    {% else %}
                                    data-value-type="manual"
                                    data-usd-value="1.0"
                                    data-usd-formula=""
                                    {% endif %}
                                    class="btn-formula bg-purple-500 text-white px-3 py-1 rounded hover:bg-purple-600 transition text-sm">
                                <i class="fas fa-calculator"></i> Fórmula
                            </button>
                            
                            <!-- Botón Editar -->
                            <button type="button"
                                    data-pm-id="{{ pm.id }}"
                                    data-pm-code="{{ pm.code }}"
                                    data-pm-name="{{ pm.name }}"
                                    data-pm-order="{{ pm.display_order }}"
                                    class="btn-edit bg-blue-500 text-white px-3 py-1 rounded hover:bg-blue-600 transition text-sm">
                                <i class="fas fa-edit"></i>
                            </button>
                            
                            <!-- Botón Eliminar -->
                            <button type="button"
                                    data-pm-id="{{ pm.id }}"
                                    data-pm-code="{{ pm.code }}"
                                    class="btn-delete bg-red-500 text-white px-3 py-1 rounded hover:bg-red-600 transition text-sm">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
</div>

<!-- Modal Agregar Método de Pago -->
<div id="addModal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
    <div class="bg-white rounded-lg shadow-xl p-6 w-full max-w-lg">
        <h3 class="text-xl font-bold text-gray-800 mb-4">
            <i class="fas fa-plus-circle text-indigo-600"></i> Agregar Método de Pago
        </h3>
        <form method="POST" action="{{ url_for('dashboard.add_payment_method') }}">
            <div class="space-y-4">
                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Código *</label>
                        <input type="text" name="code" required maxlength="20" 
                               class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 uppercase"
                               placeholder="CASHAPP">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Nombre *</label>
                        <input type="text" name="name" required maxlength="50" 
                               class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500"
                               placeholder="CashApp">
                    </div>
                </div>
                
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Tipo de valor</label>
                    <select name="value_type" id="addValueType" onchange="toggleFormulaFields('add')"
                            class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500">
                        <option value="manual">Manual (valor fijo en USD)</option>
                        <option value="formula">Fórmula (calculado)</option>
                    </select>
                </div>
                
                <div id="addManualField">
                    <label class="block text-sm font-medium text-gray-700 mb-2">Valor en USD</label>
                    <input type="number" name="usd_value" step="0.000001" value="1.0"
                           class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500">
                    <p class="text-xs text-gray-500 mt-1">Ejemplo: 1.0 para REF (base)</p>
                </div>
                
                <div id="addFormulaField" class="hidden">
                    <label class="block text-sm font-medium text-gray-700 mb-2">Fórmula en USD</label>
                    <input type="text" name="usd_formula" 
                           class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 font-mono"
                           placeholder="1 / 1.1">
                    <p class="text-xs text-gray-500 mt-1">Ejemplo: 1 / 1.1 (PayPal), 1 / 1.06 (Zelle)</p>
                </div>
            </div>
            <div class="flex justify-end space-x-3 mt-6">
                <button type="button" onclick="hideAddModal()" 
                        class="bg-gray-200 text-gray-700 px-4 py-2 rounded-lg hover:bg-gray-300 transition">
                    Cancelar
                </button>
                <button type="submit" 
                        class="bg-gradient-to-r from-indigo-500 to-purple-500 text-white px-4 py-2 rounded-lg hover:from-indigo-600 hover:to-purple-600 transition">
                    <i class="fas fa-save"></i> Guardar
                </button>
            </div>
        </form>
    </div>
</div>

<!-- Modal Editar Fórmula -->
<div id="formulaModal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
    <div class="bg-white rounded-lg shadow-xl p-6 w-full max-w-lg">
        <h3 class="text-xl font-bold text-gray-800 mb-4">
            <i class="fas fa-calculator text-purple-600"></i> Editar Fórmula: <span id="formulaMethodName"></span>
        </h3>
        <form method="POST" id="formulaForm">
            <div class="space-y-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Tipo de valor</label>
                    <select name="value_type" id="formulaValueType" onchange="toggleFormulaFields('formula')"
                            class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500">
                        <option value="manual">Manual (valor fijo en USD)</option>
                        <option value="formula">Fórmula (calculado)</option>
                    </select>
                </div>
                
                <div id="formulaManualField">
                    <label class="block text-sm font-medium text-gray-700 mb-2">Valor en USD</label>
                    <input type="number" name="usd_value" id="formulaUsdValue" step="0.000001"
                           class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500">
                </div>
                
                <div id="formulaFormulaField" class="hidden">
                    <label class="block text-sm font-medium text-gray-700 mb-2">Fórmula en USD</label>
                    <input type="text" name="usd_formula" id="formulaUsdFormula"
                           class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 font-mono"
                           placeholder="1 / 1.1">
                    <p class="text-xs text-gray-500 mt-1">Operaciones: +, -, *, /, ( )</p>
                </div>
                
                <div class="p-3 bg-yellow-50 border-l-4 border-yellow-400 rounded">
                    <p class="text-sm text-yellow-800">
                        <i class="fas fa-exclamation-triangle"></i> 
                        Al cambiar la fórmula, se recalcularán todas las cotizaciones de este método.
                    </p>
                </div>
            </div>
            <div class="flex justify-end space-x-3 mt-6">
                <button type="button" onclick="hideFormulaModal()" 
                        class="bg-gray-200 text-gray-700 px-4 py-2 rounded-lg hover:bg-gray-300 transition">
                    Cancelar
                </button>
                <button type="submit" 
                        class="bg-purple-500 text-white px-4 py-2 rounded-lg hover:bg-purple-600 transition">
                    <i class="fas fa-save"></i> Actualizar Fórmula
                </button>
            </div>
        </form>
    </div>
</div>

<!-- Modal Editar (nombre y orden) -->
<div id="editModal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
    <div class="bg-white rounded-lg shadow-xl p-6 w-full max-w-md">
        <h3 class="text-xl font-bold text-gray-800 mb-4">
            <i class="fas fa-edit text-blue-600"></i> Editar Método de Pago
        </h3>
        <form method="POST" id="editForm">
            <div class="space-y-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Código</label>
                    <input type="text" id="editCode" disabled 
                           class="w-full px-4 py-2 border border-gray-300 rounded-lg bg-gray-100">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Nombre *</label>
                    <input type="text" name="name" id="editName" required maxlength="50" 
                           class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Orden *</label>
                    <input type="number" name="display_order" id="editOrder" required min="1" 
                           class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
                    <p class="text-xs text-gray-500 mt-1">También puedes arrastrar y soltar en la tabla</p>
                </div>
            </div>
            <div class="flex justify-end space-x-3 mt-6">
                <button type="button" onclick="hideEditModal()" 
                        class="bg-gray-200 text-gray-700 px-4 py-2 rounded-lg hover:bg-gray-300 transition">
                    Cancelar
                </button>
                <button type="submit" 
                        class="bg-blue-500 text-white px-4 py-2 rounded-lg hover:bg-blue-600 transition">
                    <i class="fas fa-save"></i> Actualizar
                </button>
            </div>
        </form>
    </div>
</div>

{% endblock %}

{% block extra_js %}
<script>
// ============================================
// DRAG & DROP PARA REORDENAR
// ============================================
let draggedElement = null;

const tbody = document.getElementById('sortable-tbody');
const rows = tbody.querySelectorAll('.draggable');

rows.forEach(row => {
    row.addEventListener('dragstart', function(e) {
        draggedElement = this;
        this.classList.add('dragging');
    });
    
    row.addEventListener('dragend', function(e) {
        this.classList.remove('dragging');
        saveNewOrder();
    });
    
    row.addEventListener('dragover', function(e) {
        e.preventDefault();
        const afterElement = getDragAfterElement(tbody, e.clientY);
        if (afterElement == null) {
            tbody.appendChild(draggedElement);
        } else {
            tbody.insertBefore(draggedElement, afterElement);
        }
    });
});

function getDragAfterElement(container, y) {
    const draggableElements = [...container.querySelectorAll('.draggable:not(.dragging)')];
    
    return draggableElements.reduce((closest, child) => {
        const box = child.getBoundingClientRect();
        const offset = y - box.top - box.height / 2;
        
        if (offset < 0 && offset > closest.offset) {
            return { offset: offset, element: child };
        } else {
            return closest;
        }
    }, { offset: Number.NEGATIVE_INFINITY }).element;
}

function saveNewOrder() {
    const rows = tbody.querySelectorAll('.draggable');
    const order = Array.from(rows).map(row => parseInt(row.dataset.id));
    
    fetch('/dashboard/payment-methods/reorder', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({ order: order })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            location.reload();
        }
    });
}

// ============================================
// MODAL AGREGAR
// ============================================
function showAddModal() {
    document.getElementById('addModal').classList.remove('hidden');
}

function hideAddModal() {
    document.getElementById('addModal').classList.add('hidden');
}

function toggleFormulaFields(prefix) {
    const valueType = document.getElementById(prefix + 'ValueType').value;
    const manualField = document.getElementById(prefix + 'ManualField');
    const formulaField = document.getElementById(prefix + 'FormulaField');
    
    if (valueType === 'manual') {
        manualField.classList.remove('hidden');
        formulaField.classList.add('hidden');
    } else {
        manualField.classList.add('hidden');
        formulaField.classList.remove('hidden');
    }
}

// ============================================
// MODAL EDITAR (Nombre y Orden)
// ============================================
document.querySelectorAll('.btn-edit').forEach(btn => {
    btn.addEventListener('click', function() {
        const id = this.dataset.pmId;
        const code = this.dataset.pmCode;
        const name = this.dataset.pmName;
        const order = this.dataset.pmOrder;
        
        document.getElementById('editCode').value = code;
        document.getElementById('editName').value = name;
        document.getElementById('editOrder').value = order;
        document.getElementById('editForm').action = `/dashboard/payment-methods/${id}/edit`;
        document.getElementById('editModal').classList.remove('hidden');
    });
});

function hideEditModal() {
    document.getElementById('editModal').classList.add('hidden');
}

// ============================================
// MODAL FÓRMULA
// ============================================
document.querySelectorAll('.btn-formula').forEach(btn => {
    btn.addEventListener('click', function() {
        const id = this.dataset.pmId;
        const name = this.dataset.pmName;
        const valueType = this.dataset.valueType;
        const usdValue = this.dataset.usdValue;
        const usdFormula = this.dataset.usdFormula;
        
        document.getElementById('formulaMethodName').textContent = name;
        document.getElementById('formulaForm').action = `/dashboard/payment-methods/${id}/formula`;
        
        // Configurar tipo
        const valueTypeSelect = document.getElementById('formulaValueType');
        valueTypeSelect.value = valueType;
        
        // Mostrar campos según tipo
        if (valueType === 'manual') {
            document.getElementById('formulaManualField').classList.remove('hidden');
            document.getElementById('formulaFormulaField').classList.add('hidden');
            document.getElementById('formulaUsdValue').value = usdValue || '1.0';
        } else {
            document.getElementById('formulaManualField').classList.add('hidden');
            document.getElementById('formulaFormulaField').classList.remove('hidden');
            document.getElementById('formulaUsdFormula').value = usdFormula || '';
        }
        
        document.getElementById('formulaModal').classList.remove('hidden');
    });
});

function hideFormulaModal() {
    document.getElementById('formulaModal').classList.add('hidden');
}

// ============================================
// ELIMINAR
// ============================================
document.querySelectorAll('.btn-delete').forEach(btn => {
    btn.addEventListener('click', function() {
        const id = this.dataset.pmId;
        const code = this.dataset.pmCode;
        
        if (confirm(`¿Eliminar ${code}?\n\nSe eliminarán todas sus cotizaciones.`)) {
            const form = document.createElement('form');
            form.method = 'POST';
            form.action = `/dashboard/payment-methods/${id}/delete`;
            document.body.appendChild(form);
            form.submit();
        }
    });
});

// ============================================
// CERRAR MODALES CON ESC
// ============================================
document.addEventListener('keydown', function(e) {
    if (e.key === 'Escape') {
        hideAddModal();
        hideEditModal();
        hideFormulaModal();
    }
});
</script>
{% endblock %}
