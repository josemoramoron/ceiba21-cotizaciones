{% extends "base.html" %}

{% block title %}Gesti√≥n de Operadores{% endblock %}

{% block content %}
<div class="container mx-auto px-4 py-6">
    
    <!-- Header -->
    <div class="flex justify-between items-center mb-6">
        <div>
            <h1 class="text-3xl font-bold text-gray-900">üë®‚Äçüíº Operadores</h1>
            <p class="text-gray-600 mt-1">Gestiona los operadores del sistema</p>
        </div>
        <a href="{{ url_for('dashboard.index') }}" class="text-blue-600 hover:text-blue-800">‚Üê Volver al Dashboard</a>
    </div>
    
    <!-- Bot√≥n Agregar -->
    <div class="mb-6">
        <button onclick="showAddModal()" class="bg-green-500 hover:bg-green-600 text-white font-medium py-2 px-6 rounded">
            ‚ûï Agregar Operador
        </button>
    </div>
    
    <!-- Lista de Operadores -->
    <div class="bg-white rounded-lg shadow overflow-hidden">
        {% if operators %}
        <table class="min-w-full divide-y divide-gray-200">
            <thead class="bg-gray-50">
                <tr>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Usuario</th>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Nombre Completo</th>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Email</th>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Rol</th>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Estado</th>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Estad√≠sticas</th>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Acciones</th>
                </tr>
            </thead>
            <tbody class="bg-white divide-y divide-gray-200">
                {% for op in operators %}
                <tr class="hover:bg-gray-50">
                    <td class="px-6 py-4 whitespace-nowrap">
                        <div class="text-sm font-medium text-gray-900">{{ op.username }}</div>
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap">
                        <div class="text-sm text-gray-900">{{ op.full_name }}</div>
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap">
                        <div class="text-sm text-gray-500">{{ op.email or 'N/A' }}</div>
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap">
                        {% if op.role.value == 'admin' %}
                        <span class="px-2 py-1 text-xs font-semibold rounded bg-purple-100 text-purple-800">
                            üëë ADMIN
                        </span>
                        {% elif op.role.value == 'supervisor' %}
                        <span class="px-2 py-1 text-xs font-semibold rounded bg-blue-100 text-blue-800">
                            üëî SUPERVISOR
                        </span>
                        {% else %}
                        <span class="px-2 py-1 text-xs font-semibold rounded bg-green-100 text-green-800">
                            üë§ AGENTE
                        </span>
                        {% endif %}
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap">
                        {% if op.is_active %}
                        <span class="px-2 py-1 text-xs font-semibold rounded bg-green-100 text-green-800">
                            ‚úÖ Activo
                        </span>
                        {% else %}
                        <span class="px-2 py-1 text-xs font-semibold rounded bg-red-100 text-red-800">
                            ‚ùå Inactivo
                        </span>
                        {% endif %}
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
                        <div>√ìrdenes: {{ op.orders_completed }}</div>
                        <div class="text-xs">Promedio: {{ op.avg_processing_time }}s</div>
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm space-x-2">
                        <form method="POST" action="{{ url_for('dashboard.toggle_operator', operator_id=op.id) }}" style="display: inline;">
                            <button type="submit" class="text-blue-600 hover:text-blue-800">
                                {% if op.is_active %}Desactivar{% else %}Activar{% endif %}
                            </button>
                        </form>
                        <button data-operator-id="{{ op.id }}" data-username="{{ op.username }}" class="reset-password-btn text-yellow-600 hover:text-yellow-800">
                            üîë Reset Pass
                        </button>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
        {% else %}
        <div class="text-center py-12">
            <span class="text-6xl">üë®‚Äçüíº</span>
            <p class="mt-4 text-gray-600">No hay operadores registrados</p>
            <button onclick="showAddModal()" class="mt-4 bg-green-500 hover:bg-green-600 text-white font-medium py-2 px-6 rounded">
                ‚ûï Agregar Primer Operador
            </button>
        </div>
        {% endif %}
    </div>
    
</div>

<!-- Modal: Agregar Operador -->
<div id="addModal" class="hidden fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full z-50">
    <div class="relative top-20 mx-auto p-5 border w-96 shadow-lg rounded-md bg-white">
        <div class="mb-4">
            <h3 class="text-lg font-bold text-gray-900">‚ûï Agregar Operador</h3>
        </div>
        <form method="POST" action="{{ url_for('dashboard.add_operator') }}">
            <div class="mb-4">
                <label class="block text-sm font-medium text-gray-700 mb-1">Usuario *</label>
                <input type="text" name="username" required 
                       class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500">
            </div>
            
            <div class="mb-4">
                <label class="block text-sm font-medium text-gray-700 mb-1">Contrase√±a *</label>
                <input type="password" name="password" required 
                       class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500">
            </div>
            
            <div class="mb-4">
                <label class="block text-sm font-medium text-gray-700 mb-1">Nombre Completo *</label>
                <input type="text" name="full_name" required 
                       class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500">
            </div>
            
            <div class="mb-4">
                <label class="block text-sm font-medium text-gray-700 mb-1">Email</label>
                <input type="email" name="email" 
                       class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500">
            </div>
            
            <div class="mb-4">
                <label class="block text-sm font-medium text-gray-700 mb-1">Rol</label>
                <select name="role" class="w-full border border-gray-300 rounded px-3 py-2">
                    <option value="agent">üë§ Agente</option>
                    <option value="supervisor">üëî Supervisor</option>
                    <option value="admin">üëë Admin</option>
                </select>
            </div>
            
            <div class="flex space-x-3">
                <button type="submit" class="flex-1 bg-green-500 hover:bg-green-600 text-white py-2 px-4 rounded">
                    Crear
                </button>
                <button type="button" onclick="hideAddModal()" class="flex-1 bg-gray-300 hover:bg-gray-400 text-gray-800 py-2 px-4 rounded">
                    Cancelar
                </button>
            </div>
        </form>
    </div>
</div>

<!-- Modal: Reset Password -->
<div id="resetPasswordModal" class="hidden fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full z-50">
    <div class="relative top-20 mx-auto p-5 border w-96 shadow-lg rounded-md bg-white">
        <div class="mb-4">
            <h3 class="text-lg font-bold text-gray-900">üîë Resetear Contrase√±a</h3>
            <p class="text-sm text-gray-600 mt-1">Operador: <strong id="resetUsername"></strong></p>
        </div>
        <form method="POST" id="resetPasswordForm">
            <div class="mb-4">
                <label class="block text-sm font-medium text-gray-700 mb-1">Nueva Contrase√±a *</label>
                <input type="password" name="new_password" required 
                       class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500">
            </div>
            
            <div class="flex space-x-3">
                <button type="submit" class="flex-1 bg-yellow-500 hover:bg-yellow-600 text-white py-2 px-4 rounded">
                    Resetear
                </button>
                <button type="button" onclick="hideResetPasswordModal()" class="flex-1 bg-gray-300 hover:bg-gray-400 text-gray-800 py-2 px-4 rounded">
                    Cancelar
                </button>
            </div>
        </form>
    </div>
</div>

<script>
function showAddModal() {
    document.getElementById('addModal').classList.remove('hidden');
}

function hideAddModal() {
    document.getElementById('addModal').classList.add('hidden');
}

function showResetPasswordModal(operatorId, username) {
    document.getElementById('resetUsername').textContent = username;
    document.getElementById('resetPasswordForm').action = `/dashboard/operators/${operatorId}/reset-password`;
    document.getElementById('resetPasswordModal').classList.remove('hidden');
}

function hideResetPasswordModal() {
    document.getElementById('resetPasswordModal').classList.add('hidden');
}

// Event listeners para botones de reset password
document.querySelectorAll('.reset-password-btn').forEach(function(btn) {
    btn.addEventListener('click', function() {
        const operatorId = this.getAttribute('data-operator-id');
        const username = this.getAttribute('data-username');
        showResetPasswordModal(operatorId, username);
    });
});

// Cerrar modales con ESC
document.addEventListener('keydown', function(e) {
    if (e.key === 'Escape') {
        hideAddModal();
        hideResetPasswordModal();
    }
});
</script>

{% endblock %}
