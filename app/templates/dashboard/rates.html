{% extends "base.html" %}

{% block title %}Tasas de Cambio{% endblock %}

{% block content %}
<div class="bg-white rounded-lg shadow-lg p-6">
    <div class="flex justify-between items-center mb-6">
        <div>
            <h2 class="text-2xl font-bold text-gray-800">Tasas de Cambio</h2>
            <p class="text-gray-600 mt-1">Actualizar tasas USD ‚Üí Monedas</p>
        </div>
        <div class="flex space-x-3">
            <button onclick="updateSelectedFromAPI()" 
                    class="bg-purple-500 text-white px-4 py-2 rounded-lg hover:bg-purple-600 transition flex items-center space-x-2">
                <i class="fas fa-cloud-download-alt"></i>
                <span>Actualizar Seleccionadas desde API</span>
            </button>
            <a href="{{ url_for('dashboard.index') }}" class="text-indigo-600 hover:text-indigo-800 flex items-center">
                <i class="fas fa-arrow-left mr-2"></i> Volver a la tabla
            </a>
        </div>
    </div>

    <!-- Controles de selecci√≥n simplificados -->
    <div class="mb-4 p-4 bg-gradient-to-r from-purple-50 to-indigo-50 rounded-lg flex justify-between items-center">
        <label class="flex items-center space-x-2 cursor-pointer">
            <input type="checkbox" id="selectAll" onchange="toggleSelectAll()" 
                   class="w-5 h-5 text-indigo-600 rounded focus:ring-2 focus:ring-indigo-500">
            <span class="font-medium text-gray-700">Seleccionar todas</span>
        </label>
        <span id="selectedCount" class="text-sm text-gray-600">0 seleccionadas</span>
    </div>

    <form method="POST" id="ratesForm">
        {% for rate in rates %}
        <div class="p-4 border border-gray-200 rounded-lg hover:border-indigo-300 transition mb-3">
            <div class="flex items-center space-x-4">
                <!-- Checkbox -->
                <div class="flex-shrink-0">
                    <input type="checkbox" 
                           class="rate-checkbox w-5 h-5 text-indigo-600 rounded focus:ring-2 focus:ring-indigo-500" 
                           data-currency="{{ rate.currency.code }}"
                           onchange="updateSelectedCount()">
                </div>

                <!-- Informaci√≥n de la moneda -->
                <div class="flex-1">
                    <label class="block text-sm font-medium text-gray-700 mb-2">
                        <i class="fas fa-coins text-indigo-600"></i> 
                        1 USD = ? {{ rate.currency.code }} ({{ rate.currency.name }})
                    </label>
                    <div class="flex space-x-2">
                        <input 
                            type="number" 
                            step="0.0001" 
                            name="rate_{{ rate.currency.code }}" 
                            id="rate_{{ rate.currency.code }}"
                            value="{{ rate.rate }}" 
                            class="w-64 px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500"
                            required
                        >
                        <button 
                            type="button"
                            onclick="updateManually('{{ rate.currency.code }}')"
                            class="bg-green-500 text-white px-4 py-2 rounded-lg hover:bg-green-600 transition flex items-center space-x-2">
                            <i class="fas fa-save"></i>
                            <span>Manual</span>
                        </button>
                        <button 
                            type="button"
                            onclick="fetchSingleRate('{{ rate.currency.code }}')"
                            class="bg-purple-500 text-white px-4 py-2 rounded-lg hover:bg-purple-600 transition flex items-center space-x-2">
                            <i class="fas fa-sync-alt"></i>
                            <span>API</span>
                        </button>
                    </div>
                </div>

                <!-- Metadata -->
                <div class="text-right flex-shrink-0">
                    <p class="text-xs text-gray-600">
                        Tipo: 
                        <span id="type_{{ rate.currency.code }}" class="{% if rate.source_type == 'api' %}bg-purple-100 text-purple-800{% else %}bg-green-100 text-green-800{% endif %} px-2 py-1 rounded text-xs">
                            <i class="fas fa-{% if rate.source_type == 'api' %}cloud{% else %}hand-paper{% endif %}"></i> 
                            {{ rate.source_type|upper }}
                        </span>
                    </p>
                    <p class="text-xs text-gray-600 mt-1">
                        Actualizado: <span id="time_{{ rate.currency.code }}">{{ rate.updated_at.strftime('%d/%m/%Y %H:%M') }}</span>
                    </p>
                </div>
            </div>
        </div>
        {% endfor %}
    </form>

    <div class="mt-6 p-4 bg-blue-50 border-l-4 border-blue-400 rounded-lg">
        <p class="text-sm text-blue-800">
            <i class="fas fa-info-circle"></i> 
            <strong>Actualizaci√≥n Manual:</strong> Edita el valor y haz clic en "Manual" para guardar. 
            <strong>Actualizaci√≥n API:</strong> Haz clic en "API" para obtener la tasa autom√°ticamente.
        </p>
    </div>
</div>

<!-- Modal de progreso -->
<div id="progressModal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
    <div class="bg-white rounded-lg shadow-xl p-6 w-full max-w-md">
        <h3 class="text-xl font-bold text-gray-800 mb-4">
            <i class="fas fa-cloud-download-alt text-purple-600"></i> Actualizando Tasas
        </h3>
        <div class="space-y-3">
            <div class="flex justify-between text-sm">
                <span id="progressText">Preparando...</span>
                <span id="progressCount">0/0</span>
            </div>
            <div class="w-full bg-gray-200 rounded-full h-4">
                <div id="progressBar" class="bg-purple-600 h-4 rounded-full transition-all duration-300" style="width: 0%"></div>
            </div>
            <div id="progressLog" class="mt-4 max-h-60 overflow-y-auto space-y-2 text-sm">
                <!-- Los logs aparecer√°n aqu√≠ -->
            </div>
        </div>
        <div class="flex justify-end mt-6">
            <button id="closeProgressBtn" onclick="closeProgressModal()" disabled
                    class="bg-indigo-500 text-white px-4 py-2 rounded-lg hover:bg-indigo-600 transition disabled:opacity-50 disabled:cursor-not-allowed">
                Cerrar
            </button>
        </div>
    </div>
</div>

<!-- Notificaci√≥n Toast -->
<div id="toast" class="hidden fixed top-20 right-4 bg-white rounded-lg shadow-2xl p-4 z-50 border-l-4 min-w-80">
    <div class="flex items-center space-x-3">
        <i id="toastIcon" class="text-2xl"></i>
        <div class="flex-1">
            <p id="toastMessage" class="font-semibold"></p>
            <p id="toastDetail" class="text-sm text-gray-600"></p>
        </div>
        <button onclick="hideToast()" class="text-gray-400 hover:text-gray-600">
            <i class="fas fa-times"></i>
        </button>
    </div>
</div>

<script>
// Toast notification
function showToast(message, detail, type = 'success') {
    const toast = document.getElementById('toast');
    const icon = document.getElementById('toastIcon');
    const messageEl = document.getElementById('toastMessage');
    const detailEl = document.getElementById('toastDetail');
    
    // Configurar colores seg√∫n tipo
    if (type === 'success') {
        toast.className = 'fixed top-20 right-4 bg-white rounded-lg shadow-2xl p-4 z-50 border-l-4 border-green-500 min-w-80';
        icon.className = 'fas fa-check-circle text-2xl text-green-500';
    } else if (type === 'error') {
        toast.className = 'fixed top-20 right-4 bg-white rounded-lg shadow-2xl p-4 z-50 border-l-4 border-red-500 min-w-80';
        icon.className = 'fas fa-exclamation-circle text-2xl text-red-500';
    }
    
    messageEl.textContent = message;
    detailEl.textContent = detail;
    
    toast.classList.remove('hidden');
    
    // Auto-ocultar despu√©s de 5 segundos
    setTimeout(hideToast, 5000);
}

function hideToast() {
    document.getElementById('toast').classList.add('hidden');
}

// Actualizaci√≥n manual
function updateManually(currencyCode) {
    const input = document.getElementById(`rate_${currencyCode}`);
    const newRate = input.value;
    
    if (!newRate || parseFloat(newRate) <= 0) {
        showToast('Error', 'Ingresa una tasa v√°lida', 'error');
        return;
    }
    
    // Crear formulario para enviar
    const form = document.createElement('form');
    form.method = 'POST';
    form.action = '/dashboard/rates';
    
    const rateInput = document.createElement('input');
    rateInput.type = 'hidden';
    rateInput.name = `rate_${currencyCode}`;
    rateInput.value = newRate;
    
    form.appendChild(rateInput);
    document.body.appendChild(form);
    
    // Enviar
    fetch('/dashboard/rates', {
        method: 'POST',
        body: new FormData(form)
    })
    .then(response => {
        if (response.ok) {
            showToast('‚úÖ Tasa actualizada', `1 USD = ${parseFloat(newRate).toFixed(4)} ${currencyCode}`, 'success');
            
            // Actualizar badge a MANUAL
            const badge = document.getElementById(`type_${currencyCode}`);
            badge.className = 'bg-green-100 text-green-800 px-2 py-1 rounded text-xs';
            badge.innerHTML = '<i class="fas fa-hand-paper"></i> MANUAL';
            
            // Actualizar timestamp
            const now = new Date();
            document.getElementById(`time_${currencyCode}`).textContent = 
                now.toLocaleDateString('es-ES') + ' ' + now.toLocaleTimeString('es-ES', {hour: '2-digit', minute:'2-digit'});
        } else {
            showToast('Error', 'No se pudo actualizar la tasa', 'error');
        }
    })
    .catch(error => {
        showToast('Error', 'Error de conexi√≥n', 'error');
    });
}

// Actualizar desde API (individual)
function fetchSingleRate(currencyCode) {
    const button = event.target.closest('button');
    const originalHTML = button.innerHTML;
    
    button.disabled = true;
    button.innerHTML = '<i class="fas fa-spinner fa-spin"></i>';
    
    fetch(`/dashboard/api/fetch-rate/${currencyCode}`, {
        method: 'POST',
        headers: {'Content-Type': 'application/json'}
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            document.getElementById(`rate_${currencyCode}`).value = data.rate.toFixed(4);
            showToast('‚úÖ Tasa desde API', `1 USD = ${data.rate.toFixed(4)} ${currencyCode} (${data.provider})`, 'success');
            
            // Actualizar badge a API
            const badge = document.getElementById(`type_${currencyCode}`);
            badge.className = 'bg-purple-100 text-purple-800 px-2 py-1 rounded text-xs';
            badge.innerHTML = '<i class="fas fa-cloud"></i> API';
            
            // Actualizar timestamp
            const now = new Date();
            document.getElementById(`time_${currencyCode}`).textContent = 
                now.toLocaleDateString('es-ES') + ' ' + now.toLocaleTimeString('es-ES', {hour: '2-digit', minute:'2-digit'});
            
            button.disabled = false;
            button.innerHTML = originalHTML;
        } else {
            showToast('Error API', data.error, 'error');
            button.disabled = false;
            button.innerHTML = originalHTML;
        }
    })
    .catch(error => {
        showToast('Error', 'Error de conexi√≥n', 'error');
        button.disabled = false;
        button.innerHTML = originalHTML;
    });
}

// Selecci√≥n de checkboxes
function toggleSelectAll() {
    const selectAll = document.getElementById('selectAll');
    const checkboxes = document.querySelectorAll('.rate-checkbox');
    checkboxes.forEach(cb => cb.checked = selectAll.checked);
    updateSelectedCount();
}

function updateSelectedCount() {
    const checkboxes = document.querySelectorAll('.rate-checkbox:checked');
    const count = checkboxes.length;
    document.getElementById('selectedCount').textContent = `${count} seleccionada${count !== 1 ? 's' : ''}`;
    
    const allCheckboxes = document.querySelectorAll('.rate-checkbox');
    document.getElementById('selectAll').checked = count === allCheckboxes.length;
}

// Actualizar m√∫ltiples desde API
async function updateSelectedFromAPI() {
    const checkboxes = document.querySelectorAll('.rate-checkbox:checked');
    
    if (checkboxes.length === 0) {
        showToast('Aviso', 'Selecciona al menos una moneda', 'error');
        return;
    }
    
    const currencies = Array.from(checkboxes).map(cb => cb.dataset.currency);
    
    if (!confirm(`¬øActualizar ${currencies.length} moneda${currencies.length > 1 ? 's' : ''} desde API?\n\n${currencies.join(', ')}`)) {
        return;
    }
    
    showProgressModal();
    
    let successful = 0;
    let failed = 0;
    
    for (let i = 0; i < currencies.length; i++) {
        const currency = currencies[i];
        updateProgress(i + 1, currencies.length, `Actualizando ${currency}...`);
        
        try {
            const response = await fetch(`/dashboard/api/fetch-rate/${currency}`, {
                method: 'POST',
                headers: {'Content-Type': 'application/json'}
            });
            
            const data = await response.json();
            
            if (data.success) {
                addProgressLog(`‚úÖ ${currency}: ${data.rate.toFixed(4)} (${data.provider})`, 'success');
                document.getElementById(`rate_${currency}`).value = data.rate.toFixed(4);
                
                // Actualizar badge
                const badge = document.getElementById(`type_${currency}`);
                badge.className = 'bg-purple-100 text-purple-800 px-2 py-1 rounded text-xs';
                badge.innerHTML = '<i class="fas fa-cloud"></i> API';
                
                successful++;
            } else {
                addProgressLog(`‚ùå ${currency}: ${data.error}`, 'error');
                failed++;
            }
        } catch (error) {
            addProgressLog(`‚ùå ${currency}: Error de conexi√≥n`, 'error');
            failed++;
        }
        
        if (i < currencies.length - 1) {
            await new Promise(resolve => setTimeout(resolve, 500));
        }
    }
    
    updateProgress(currencies.length, currencies.length, '‚úÖ Proceso completado');
    addProgressLog(`\nüìä Resumen: ${successful} exitosas, ${failed} fallidas`, 'info');
    
    document.getElementById('closeProgressBtn').disabled = false;
}

// Modal de progreso
function showProgressModal() {
    document.getElementById('progressModal').classList.remove('hidden');
    document.getElementById('progressLog').innerHTML = '';
    document.getElementById('closeProgressBtn').disabled = true;
}

function closeProgressModal() {
    document.getElementById('progressModal').classList.add('hidden');
}

function updateProgress(current, total, text) {
    const percentage = (current / total) * 100;
    document.getElementById('progressBar').style.width = percentage + '%';
    document.getElementById('progressText').textContent = text;
    document.getElementById('progressCount').textContent = `${current}/${total}`;
}

function addProgressLog(message, type = 'info') {
    const log = document.getElementById('progressLog');
    const entry = document.createElement('div');
    
    let colorClass = 'text-gray-700';
    if (type === 'success') colorClass = 'text-green-700';
    if (type === 'error') colorClass = 'text-red-700';
    if (type === 'info') colorClass = 'text-blue-700';
    
    entry.className = `p-2 bg-gray-50 rounded ${colorClass}`;
    entry.textContent = message;
    
    log.appendChild(entry);
    log.scrollTop = log.scrollHeight;
}

document.addEventListener('DOMContentLoaded', updateSelectedCount);
</script>
{% endblock %}
