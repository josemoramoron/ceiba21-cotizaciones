{% extends "base.html" %}

{% block title %}Gestión de Monedas{% endblock %}

{% block content %}
<div class="bg-white rounded-lg shadow-lg p-6">
    <!-- Header -->
    <div class="flex justify-between items-center mb-6">
        <div>
            <h2 class="text-2xl font-bold text-gray-800">Gestión de Monedas</h2>
            <p class="text-gray-600 mt-1">Administrar las monedas del sistema</p>
        </div>
        <button onclick="showAddModal()" class="bg-gradient-to-r from-indigo-500 to-purple-500 text-white px-4 py-2 rounded-lg hover:from-indigo-600 hover:to-purple-600 transition">
            <i class="fas fa-plus"></i> Agregar Moneda
        </button>
    </div>

    <!-- Tabla de Monedas -->
    <div class="overflow-x-auto">
        <table class="min-w-full bg-white border border-gray-200 rounded-lg">
            <thead class="bg-gradient-to-r from-indigo-500 to-purple-500 text-white">
                <tr>
                    <th class="px-6 py-3 text-left">Código</th>
                    <th class="px-6 py-3 text-left">Nombre</th>
                    <th class="px-6 py-3 text-left">Símbolo</th>
                    <th class="px-6 py-3 text-left">Estado</th>
                    <th class="px-6 py-3 text-left">Fecha Creación</th>
                    <th class="px-6 py-3 text-center">Acciones</th>
                </tr>
            </thead>
            <tbody>
                {% for currency in currencies %}
                <tr class="border-b hover:bg-gray-50 transition">
                    <td class="px-6 py-4">
                        <span class="font-bold text-indigo-600">{{ currency.code }}</span>
                    </td>
                    <td class="px-6 py-4">{{ currency.name }}</td>
                    <td class="px-6 py-4">
                        <span class="text-2xl">{{ currency.symbol }}</span>
                    </td>
                    <td class="px-6 py-4">
                        {% if currency.active %}
                        <span class="bg-green-100 text-green-800 text-xs px-2 py-1 rounded">Activa</span>
                        {% else %}
                        <span class="bg-red-100 text-red-800 text-xs px-2 py-1 rounded">Inactiva</span>
                        {% endif %}
                    </td>
                    <td class="px-6 py-4 text-sm text-gray-600">
                        {{ currency.created_at.strftime('%d/%m/%Y') }}
                    </td>

			<td class="px-6 py-4">
			    <div class="flex justify-center space-x-2">
			        <!-- Toggle Activo/Inactivo -->
			        <form method="POST" action="{{ url_for('dashboard.toggle_currency', currency_id=currency.id) }}" class="inline">
			            <button type="submit" 
			                    class="{% if currency.active %}bg-yellow-500 hover:bg-yellow-600{% else %}bg-green-500 hover:bg-green-600{% endif %} text-white px-3 py-1 rounded transition text-sm">
			                <i class="fas fa-{% if currency.active %}eye-slash{% else %}eye{% endif %}"></i>
			                {% if currency.active %}Desactivar{% else %}Activar{% endif %}
			            </button>
			        </form>
			        
			        <!-- Editar -->
			        <button onclick="showEditModal({{ currency.id }}, '{{ currency.code }}', '{{ currency.name }}', '{{ currency.symbol }}')" 
			                class="bg-blue-500 text-white px-3 py-1 rounded hover:bg-blue-600 transition text-sm">
			            <i class="fas fa-edit"></i> Editar
			        </button>
			        
			        <!-- Eliminar -->
			        <button onclick="deleteCurrency({{ currency.id }}, '{{ currency.code }}')" 
			                class="bg-red-500 text-white px-3 py-1 rounded hover:bg-red-600 transition text-sm">
			            <i class="fas fa-trash"></i>
			        </button>
			    </div>
			</td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>

    {% if currencies|length == 0 %}
    <div class="text-center py-8 text-gray-500">
        <i class="fas fa-inbox text-4xl mb-2"></i>
        <p>No hay monedas registradas</p>
    </div>
    {% endif %}
</div>

<!-- Modal Agregar Moneda -->
<div id="addModal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
    <div class="bg-white rounded-lg shadow-xl p-6 w-full max-w-md">
        <h3 class="text-xl font-bold text-gray-800 mb-4">
            <i class="fas fa-plus-circle text-indigo-600"></i> Agregar Nueva Moneda
        </h3>
        <form method="POST" action="{{ url_for('dashboard.add_currency') }}">
            <div class="space-y-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Código * (3 letras)</label>
                    <input type="text" name="code" required maxlength="3" minlength="3"
                           class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 uppercase"
                           placeholder="BRL, MXN, PEN">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Nombre *</label>
                    <input type="text" name="name" required maxlength="50" 
                           class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500"
                           placeholder="Real Brasileño">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Símbolo</label>
                    <input type="text" name="symbol" maxlength="10" 
                           class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500"
                           placeholder="R$">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Tasa de Cambio Inicial (1 USD = ?)</label>
                    <input type="number" name="initial_rate" step="0.01" min="0"
                           class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500"
                           placeholder="5.20">
                    <p class="text-xs text-gray-500 mt-1">Ejemplo: Si 1 USD = 5.20 BRL, escribe 5.20</p>
                </div>
            </div>
            <div class="flex justify-end space-x-3 mt-6">
                <button type="button" onclick="hideAddModal()" 
                        class="bg-gray-200 text-gray-700 px-4 py-2 rounded-lg hover:bg-gray-300 transition">
                    Cancelar
                </button>
                <button type="submit" 
                        class="bg-gradient-to-r from-indigo-500 to-purple-500 text-white px-4 py-2 rounded-lg hover:from-indigo-600 hover:to-purple-600 transition">
                    <i class="fas fa-save"></i> Guardar
                </button>
            </div>
        </form>
    </div>
</div>

<!-- Modal Editar Moneda -->
<div id="editModal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
    <div class="bg-white rounded-lg shadow-xl p-6 w-full max-w-md">
        <h3 class="text-xl font-bold text-gray-800 mb-4">
            <i class="fas fa-edit text-blue-600"></i> Editar Moneda
        </h3>
        <form method="POST" id="editForm">
            <div class="space-y-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Código</label>
                    <input type="text" id="editCode" disabled 
                           class="w-full px-4 py-2 border border-gray-300 rounded-lg bg-gray-100">
                    <p class="text-xs text-gray-500 mt-1">El código no se puede cambiar después de crear la moneda</p>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Nombre *</label>
                    <input type="text" name="name" id="editName" required maxlength="50" 
                           class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Símbolo</label>
                    <input type="text" name="symbol" id="editSymbol" maxlength="10" 
                           class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
                </div>
                <div class="p-3 bg-blue-50 border-l-4 border-blue-400 rounded">
                    <p class="text-sm text-blue-800">
                        <i class="fas fa-info-circle"></i> 
                        Para cambiar el estado activo/inactivo, usa el botón de la tabla.
                    </p>
                </div>
            </div>
            <div class="flex justify-end space-x-3 mt-6">
                <button type="button" onclick="hideEditModal()" 
                        class="bg-gray-200 text-gray-700 px-4 py-2 rounded-lg hover:bg-gray-300 transition">
                    Cancelar
                </button>
                <button type="submit" 
                        class="bg-blue-500 text-white px-4 py-2 rounded-lg hover:bg-blue-600 transition">
                    <i class="fas fa-save"></i> Actualizar
                </button>
            </div>
        </form>
    </div>
</div>

<script>
// Modal Agregar
function showAddModal() {
    document.getElementById('addModal').classList.remove('hidden');
}

function hideAddModal() {
    document.getElementById('addModal').classList.add('hidden');
}

// Modal Editar
function showEditModal(id, code, name, symbol) {
    document.getElementById('editCode').value = code;
    document.getElementById('editName').value = name;
    document.getElementById('editSymbol').value = symbol;
    document.getElementById('editForm').action = `/dashboard/currencies/${id}/edit`;
    document.getElementById('editModal').classList.remove('hidden');
}

function hideEditModal() {
    document.getElementById('editModal').classList.add('hidden');
}

// Eliminar
function deleteCurrency(id, code) {
    if (confirm(`¿Estás seguro de eliminar la moneda ${code}?\n\nEsto eliminará todas sus cotizaciones asociadas.`)) {
        const form = document.createElement('form');
        form.method = 'POST';
        form.action = `/dashboard/currencies/${id}/delete`;
        document.body.appendChild(form);
        form.submit();
    }
}

// Cerrar modal con ESC
document.addEventListener('keydown', function(e) {
    if (e.key === 'Escape') {
        hideAddModal();
        hideEditModal();
    }
});
</script>
{% endblock %}
